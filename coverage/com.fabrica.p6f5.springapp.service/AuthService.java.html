<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">billing-and-payments-p6f5</a> &gt; <a href="index.source.html" class="el_package">com.fabrica.p6f5.springapp.service</a> &gt; <span class="el_source">AuthService.java</span></div><h1>AuthService.java</h1><pre class="source lang-java linenums">package com.fabrica.p6f5.springapp.service;

import com.fabrica.p6f5.springapp.dto.AuthResponse;
import com.fabrica.p6f5.springapp.dto.LoginRequest;
import com.fabrica.p6f5.springapp.dto.RegisterRequest;
import com.fabrica.p6f5.springapp.entity.User;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import java.util.Optional;

/**
 * Authentication Service following Single Responsibility Principle.
 * This service is responsible only for authentication operations.
 */
@Service
public class AuthService {
    
    private final UserService userService;
    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;
    
    @Autowired
<span class="fc" id="L29">    public AuthService(UserService userService, JwtService jwtService, AuthenticationManager authenticationManager) {</span>
<span class="fc" id="L30">        this.userService = userService;</span>
<span class="fc" id="L31">        this.jwtService = jwtService;</span>
<span class="fc" id="L32">        this.authenticationManager = authenticationManager;</span>
<span class="fc" id="L33">    }</span>
    
    /**
     * Register a new user.
     * 
     * @param request the registration request
     * @return AuthResponse with token and user details
     * @throws RuntimeException if user already exists
     */
    public AuthResponse register(RegisterRequest request) {
        // Check if user already exists
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (userService.existsByUsername(request.getUsername())) {</span>
<span class="nc" id="L45">            throw new RuntimeException(&quot;Username is already taken!&quot;);</span>
        }
        
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (userService.existsByEmail(request.getEmail())) {</span>
<span class="nc" id="L49">            throw new RuntimeException(&quot;Email is already in use!&quot;);</span>
        }
        
        // Create new user
<span class="nc" id="L53">        User user = request.toUser();</span>
<span class="nc" id="L54">        User savedUser = userService.save(user);</span>
        
        // Generate JWT token
<span class="nc" id="L57">        String token = jwtService.generateToken(savedUser);</span>
        
<span class="nc" id="L59">        return new AuthResponse(</span>
                token,
<span class="nc" id="L61">                savedUser.getUsername(),</span>
<span class="nc" id="L62">                savedUser.getEmail(),</span>
<span class="nc" id="L63">                savedUser.getId()</span>
        );
    }
    
    /**
     * Authenticate user and return JWT token.
     * 
     * @param request the login request
     * @return AuthResponse with token and user details
     * @throws RuntimeException if authentication fails
     */
    public AuthResponse login(LoginRequest request) {
        // Authenticate user
<span class="nc" id="L76">        Authentication authentication = authenticationManager.authenticate(</span>
                new UsernamePasswordAuthenticationToken(
<span class="nc" id="L78">                        request.getUsernameOrEmail(),</span>
<span class="nc" id="L79">                        request.getPassword()</span>
                )
        );
        
        // Get user details
<span class="nc" id="L84">        User user = (User) authentication.getPrincipal();</span>
        
        // Generate JWT token
<span class="nc" id="L87">        String token = jwtService.generateToken(user);</span>
        
<span class="nc" id="L89">        return new AuthResponse(</span>
                token,
<span class="nc" id="L91">                user.getUsername(),</span>
<span class="nc" id="L92">                user.getEmail(),</span>
<span class="nc" id="L93">                user.getId()</span>
        );
    }
    
    /**
     * Get current authenticated user.
     * 
     * @return Optional containing the current user
     */
    public Optional&lt;User&gt; getCurrentUser() {
<span class="nc" id="L103">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">        if (authentication != null &amp;&amp; authentication.getPrincipal() instanceof User) {</span>
<span class="nc" id="L105">            return Optional.of((User) authentication.getPrincipal());</span>
        }
<span class="nc" id="L107">        return Optional.empty();</span>
    }
    
    /**
     * Validate JWT token.
     * 
     * @param token the JWT token
     * @return true if valid, false otherwise
     */
    public boolean validateToken(String token) {
        try {
<span class="nc" id="L118">            String username = jwtService.extractUsername(token);</span>
<span class="nc" id="L119">            UserDetails userDetails = userService.loadUserByUsername(username);</span>
<span class="nc" id="L120">            return jwtService.isTokenValid(token, userDetails);</span>
<span class="nc" id="L121">        } catch (Exception e) {</span>
<span class="nc" id="L122">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>